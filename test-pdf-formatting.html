<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF格式排版测试</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            resize: vertical;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        
        .test-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .sample-text {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .formatting-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .option-group {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .option-group select, .option-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-file-pdf"></i> PDF格式排版测试</h1>
        
        <div class="test-section">
            <h2>测试PDF格式排版</h2>
            <p>输入包含段落、换行、中英文混合的文本，测试PDF的排版效果。</p>
            
            <div class="sample-text">
                <strong>示例文本（包含段落和格式）：</strong><br>
                这是一个测试文档，用于验证PDF格式排版功能。
                包含中文和英文内容，以及多个段落。
                This is a test document for PDF formatting verification.
                It contains both Chinese and English content.
            </div>
            
            <textarea id="textInput" class="text-input" placeholder="请输入要转换为PDF的文本内容...">
这是一个测试文档，用于验证PDF格式排版功能。

文档包含以下内容：
1. 中文文本支持
2. 英文文本支持
3. 数字和符号
4. 多段落内容
5. 换行和格式

This is a test document for PDF formatting verification.

The document includes:
1. Chinese text support
2. English text support
3. Numbers and symbols
4. Multiple paragraphs
5. Line breaks and formatting

测试结果应该生成一个排版良好的PDF文件。
The test result should generate a well-formatted PDF file.

注意事项：
- 段落之间应该有适当的间距
- 中英文混合应该有正确的排版
- 换行符应该被正确处理
- 页面边距应该合理设置

Notes:
- There should be proper spacing between paragraphs
- Mixed Chinese and English should have correct formatting
- Line breaks should be handled properly
- Page margins should be set reasonably
            </textarea>
            
            <div class="formatting-options">
                <div class="option-group">
                    <label for="fontSize">字体大小</label>
                    <select id="fontSize">
                        <option value="10">10pt - 小字体</option>
                        <option value="12" selected>12pt - 标准字体</option>
                        <option value="14">14pt - 大字体</option>
                        <option value="16">16pt - 特大字体</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="lineHeight">行高</label>
                    <select id="lineHeight">
                        <option value="6">6mm - 紧凑</option>
                        <option value="8" selected>8mm - 标准</option>
                        <option value="10">10mm - 宽松</option>
                        <option value="12">12mm - 很宽松</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="margin">页边距</label>
                    <select id="margin">
                        <option value="15">15mm - 窄边距</option>
                        <option value="20" selected>20mm - 标准边距</option>
                        <option value="25">25mm - 宽边距</option>
                        <option value="30">30mm - 很宽边距</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="paragraphSpacing">段落间距</label>
                    <select id="paragraphSpacing">
                        <option value="8">8mm - 紧凑</option>
                        <option value="12" selected>12mm - 标准</option>
                        <option value="16">16mm - 宽松</option>
                        <option value="20">20mm - 很宽松</option>
                    </select>
                </div>
            </div>
            
            <div>
                <button id="generatePDF" class="test-button">
                    <i class="fas fa-file-pdf"></i> 生成PDF
                </button>
                <button id="clearText" class="test-button">
                    <i class="fas fa-trash"></i> 清空文本
                </button>
                <button id="loadSample" class="test-button">
                    <i class="fas fa-file-alt"></i> 加载示例
                </button>
            </div>
            
            <div id="testResult" class="test-result" style="display: none;">
                <!-- 测试结果将在这里显示 -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>排版功能说明</h2>
            <ul>
                <li><strong>段落处理</strong>：自动识别段落分隔，添加适当间距</li>
                <li><strong>换行处理</strong>：正确处理换行符和空行</li>
                <li><strong>中英文混合</strong>：支持中英文混合排版</li>
                <li><strong>自动分页</strong>：内容超过一页时自动分页</li>
                <li><strong>边距设置</strong>：可调整页面边距和行间距</li>
                <li><strong>字体设置</strong>：支持不同字体大小</li>
            </ul>
        </div>
    </div>

    <!-- jsPDF库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const textInput = document.getElementById('textInput');
            const testResult = document.getElementById('testResult');
            
            // 生成PDF
            document.getElementById('generatePDF').addEventListener('click', async function() {
                const text = textInput.value.trim();
                
                if (!text) {
                    showResult('请输入要转换的文本内容', 'error');
                    return;
                }
                
                const fontSize = parseInt(document.getElementById('fontSize').value);
                const lineHeight = parseInt(document.getElementById('lineHeight').value);
                const margin = parseInt(document.getElementById('margin').value);
                const paragraphSpacing = parseInt(document.getElementById('paragraphSpacing').value);
                
                showResult('正在生成PDF文件...', 'info');
                
                try {
                    const pdfBlob = await generateFormattedPDF(text, {
                        fontSize,
                        lineHeight,
                        margin,
                        paragraphSpacing
                    });
                    
                    // 创建下载链接
                    const url = URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'formatted-document.pdf';
                    link.textContent = '下载PDF文件';
                    link.className = 'test-button';
                    link.style.display = 'inline-block';
                    link.style.marginTop = '10px';
                    
                    showResult(`
                        <div class="test-success">
                            <h3>PDF生成成功！</h3>
                            <p>文件大小: ${formatFileSize(pdfBlob.size)}</p>
                            <p>字体大小: ${fontSize}pt</p>
                            <p>行高: ${lineHeight}mm</p>
                            <p>页边距: ${margin}mm</p>
                            <p>段落间距: ${paragraphSpacing}mm</p>
                            <p>点击下方按钮下载PDF文件：</p>
                        </div>
                    `, 'success');
                    
                    testResult.appendChild(link);
                    
                } catch (error) {
                    showResult(`
                        <div class="test-error">
                            <h3>PDF生成失败</h3>
                            <p>错误信息: ${error.message}</p>
                        </div>
                    `, 'error');
                }
            });
            
            // 清空文本
            document.getElementById('clearText').addEventListener('click', function() {
                textInput.value = '';
                hideResult();
            });
            
            // 加载示例
            document.getElementById('loadSample').addEventListener('click', function() {
                textInput.value = `这是一个示例文档，用于测试PDF格式排版功能。

文档特点：
1. 支持中文字符
2. 支持英文字符
3. 支持数字和符号
4. 支持多段落内容
5. 支持换行和格式
6. 支持中英文混合

This is a sample document for testing PDF formatting.

Document features:
1. Chinese character support
2. English character support
3. Numbers and symbols support
4. Multiple paragraphs
5. Line breaks and formatting
6. Mixed Chinese and English

测试结果应该生成一个排版良好的PDF文件。
The test result should generate a well-formatted PDF file.

注意事项：
- 段落之间应该有适当的间距
- 中英文混合应该有正确的排版
- 换行符应该被正确处理
- 页面边距应该合理设置

Notes:
- There should be proper spacing between paragraphs
- Mixed Chinese and English should have correct formatting
- Line breaks should be handled properly
- Page margins should be set reasonably`;
            });
            
            // 生成格式化的PDF
            async function generateFormattedPDF(text, options) {
                return new Promise((resolve) => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // 设置字体和样式
                    doc.setFont('helvetica');
                    doc.setFontSize(options.fontSize);
                    
                    // 页面设置
                    const pageWidth = 210; // A4宽度 (mm)
                    const pageHeight = 297; // A4高度 (mm)
                    const maxWidth = pageWidth - 2 * options.margin; // 可用宽度
                    
                    // 处理文本格式
                    const paragraphs = parseTextIntoParagraphs(text);
                    
                    let y = options.margin; // 起始Y坐标
                    
                    for (let paragraphIndex = 0; paragraphIndex < paragraphs.length; paragraphIndex++) {
                        const paragraph = paragraphs[paragraphIndex];
                        
                        // 检查是否需要新页面
                        if (y + options.lineHeight > pageHeight - options.margin) {
                            doc.addPage();
                            y = options.margin;
                        }
                        
                        // 处理段落
                        const lines = splitParagraphIntoLines(paragraph, maxWidth, options.fontSize);
                        
                        for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                            const line = lines[lineIndex];
                            
                            // 检查是否需要新页面
                            if (y + options.lineHeight > pageHeight - options.margin) {
                                doc.addPage();
                                y = options.margin;
                            }
                            
                            // 绘制文本行
                            doc.text(line, options.margin, y);
                            y += options.lineHeight;
                        }
                        
                        // 段落间距（除了最后一个段落）
                        if (paragraphIndex < paragraphs.length - 1) {
                            y += options.paragraphSpacing - options.lineHeight;
                        }
                    }
                    
                    // 生成PDF Blob
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                });
            }
            
            // 将文本解析为段落
            function parseTextIntoParagraphs(text) {
                const lines = text.split(/\r?\n/);
                const paragraphs = [];
                let currentParagraph = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === '') {
                        if (currentParagraph.trim() !== '') {
                            paragraphs.push(currentParagraph.trim());
                            currentParagraph = '';
                        }
                    } else {
                        if (currentParagraph !== '') {
                            currentParagraph += ' ';
                        }
                        currentParagraph += line;
                    }
                }
                
                if (currentParagraph.trim() !== '') {
                    paragraphs.push(currentParagraph.trim());
                }
                
                return paragraphs;
            }
            
            // 将段落分割成适合PDF页面的行
            function splitParagraphIntoLines(paragraph, maxWidth, fontSize) {
                const words = paragraph.split(/\s+/);
                const lines = [];
                let currentLine = '';
                
                for (const word of words) {
                    const testLine = currentLine + (currentLine ? ' ' : '') + word;
                    const estimatedWidth = estimateTextWidth(testLine, fontSize);
                    
                    if (estimatedWidth <= maxWidth) {
                        currentLine = testLine;
                    } else {
                        if (currentLine) {
                            lines.push(currentLine);
                        }
                        currentLine = word;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }
            
            // 估算文本宽度
            function estimateTextWidth(text, fontSize) {
                let width = 0;
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (isChineseChar(char)) {
                        width += 1.5; // 中文字符
                    } else {
                        width += 1; // 英文字符
                    }
                }
                return width * (fontSize / 12) * 2.5; // 转换为毫米
            }
            
            // 检查是否为中文字符
            function isChineseChar(char) {
                return /[\u4e00-\u9fff]/.test(char);
            }
            
            // 显示结果
            function showResult(message, type) {
                testResult.innerHTML = message;
                testResult.className = `test-result test-${type}`;
                testResult.style.display = 'block';
            }
            
            // 隐藏结果
            function hideResult() {
                testResult.style.display = 'none';
            }
            
            // 格式化文件大小
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html> 