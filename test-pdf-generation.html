<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF生成功能测试</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .test-input {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        
        .test-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .sample-text {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-file-pdf"></i> PDF生成功能测试</h1>
        
        <div class="test-section">
            <h2>测试PDF生成</h2>
            <p>输入文本内容，测试PDF生成功能是否正常工作。</p>
            
            <div class="sample-text">
                <strong>示例文本：</strong><br>
                这是一个测试文档，用于验证PDF生成功能。包含中文和英文内容。
                This is a test document for PDF generation verification. It contains both Chinese and English content.
                文档包含多个段落，用于测试分页功能。每个段落都有不同的内容。
                The document contains multiple paragraphs to test pagination. Each paragraph has different content.
            </div>
            
            <textarea id="testText" class="test-input" placeholder="请输入要转换为PDF的文本内容...">
这是一个测试文档，用于验证PDF生成功能。

文档包含以下内容：
1. 中文文本支持
2. 英文文本支持
3. 数字和符号
4. 多段落内容

This is a test document for PDF generation verification.

The document includes:
1. Chinese text support
2. English text support
3. Numbers and symbols
4. Multiple paragraphs

测试结果应该生成一个可以正常打开的PDF文件。
The test result should generate a PDF file that can be opened normally.
            </textarea>
            
            <div>
                <button id="generatePDF" class="test-button">
                    <i class="fas fa-file-pdf"></i> 生成PDF
                </button>
                <button id="clearText" class="test-button">
                    <i class="fas fa-trash"></i> 清空文本
                </button>
                <button id="loadSample" class="test-button">
                    <i class="fas fa-file-alt"></i> 加载示例
                </button>
            </div>
            
            <div id="testResult" class="test-result" style="display: none;">
                <!-- 测试结果将在这里显示 -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>功能说明</h2>
            <ul>
                <li><strong>PDF生成</strong>：使用jsPDF库生成标准的PDF文件</li>
                <li><strong>中文支持</strong>：支持中文字符的正确显示</li>
                <li><strong>自动分页</strong>：内容超过一页时自动分页</li>
                <li><strong>格式保持</strong>：保持文本的基本格式和段落结构</li>
                <li><strong>文件下载</strong>：生成的PDF文件可以直接下载</li>
            </ul>
        </div>
    </div>

    <!-- jsPDF库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const testText = document.getElementById('testText');
            const testResult = document.getElementById('testResult');
            
            // 生成PDF
            document.getElementById('generatePDF').addEventListener('click', async function() {
                const text = testText.value.trim();
                
                if (!text) {
                    showResult('请输入要转换的文本内容', 'error');
                    return;
                }
                
                showResult('正在生成PDF文件...', 'info');
                
                try {
                    const pdfBlob = await generatePDF(text);
                    
                    // 创建下载链接
                    const url = URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'test-document.pdf';
                    link.textContent = '下载PDF文件';
                    link.className = 'test-button';
                    link.style.display = 'inline-block';
                    link.style.marginTop = '10px';
                    
                    showResult(`
                        <div class="test-success">
                            <h3>PDF生成成功！</h3>
                            <p>文件大小: ${formatFileSize(pdfBlob.size)}</p>
                            <p>文件类型: ${pdfBlob.type}</p>
                            <p>点击下方按钮下载PDF文件：</p>
                        </div>
                    `, 'success');
                    
                    testResult.appendChild(link);
                    
                } catch (error) {
                    showResult(`
                        <div class="test-error">
                            <h3>PDF生成失败</h3>
                            <p>错误信息: ${error.message}</p>
                        </div>
                    `, 'error');
                }
            });
            
            // 清空文本
            document.getElementById('clearText').addEventListener('click', function() {
                testText.value = '';
                hideResult();
            });
            
            // 加载示例
            document.getElementById('loadSample').addEventListener('click', function() {
                testText.value = `这是一个示例文档，用于测试PDF生成功能。

文档特点：
1. 支持中文字符
2. 支持英文字符
3. 支持数字和符号
4. 支持多段落内容
5. 支持自动分页

This is a sample document for testing PDF generation.

Document features:
1. Chinese character support
2. English character support
3. Numbers and symbols support
4. Multiple paragraphs
5. Automatic pagination

测试结果应该生成一个标准的PDF文件，可以在任何PDF阅读器中正常打开。
The test result should generate a standard PDF file that can be opened normally in any PDF reader.`;
            });
            
            // 生成PDF函数
            async function generatePDF(text) {
                return new Promise((resolve, reject) => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // 设置字体和大小
                        doc.setFont('helvetica');
                        doc.setFontSize(12);
                        
                        // 分割文本以适应页面
                        const maxWidth = 190; // A4页面宽度减去边距
                        const lineHeight = 7;
                        const lines = splitTextIntoLines(text, maxWidth);
                        
                        let y = 20; // 起始Y坐标
                        const pageHeight = 280; // A4页面高度减去边距
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            
                            // 检查是否需要新页面
                            if (y + lineHeight > pageHeight) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(line, 10, y);
                            y += lineHeight;
                        }
                        
                        // 生成PDF Blob
                        const pdfBlob = doc.output('blob');
                        resolve(pdfBlob);
                        
                    } catch (error) {
                        reject(new Error(`PDF生成失败: ${error.message}`));
                    }
                });
            }
            
            // 将文本分割成适合PDF页面的行
            function splitTextIntoLines(text, maxWidth) {
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';
                
                for (const word of words) {
                    const testLine = currentLine + (currentLine ? ' ' : '') + word;
                    if (testLine.length * 6 <= maxWidth) { // 估算字符宽度
                        currentLine = testLine;
                    } else {
                        if (currentLine) {
                            lines.push(currentLine);
                        }
                        currentLine = word;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines;
            }
            
            // 显示结果
            function showResult(message, type) {
                testResult.innerHTML = message;
                testResult.className = `test-result test-${type}`;
                testResult.style.display = 'block';
            }
            
            // 隐藏结果
            function hideResult() {
                testResult.style.display = 'none';
            }
            
            // 格式化文件大小
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html> 